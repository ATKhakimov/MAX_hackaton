"""
–õ–∞–π—Ç-–≤–µ—Ä—Å–∏—è –±–æ—Ç–∞ –¥–ª—è –≥—Ä—É–ø–ø–æ–≤—ã—Ö —á–∞—Ç–æ–≤.
–í–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–µ —Ç–æ–ª—å–∫–æ —á–µ—Ä–µ–∑ —É–ø–æ–º–∏–Ω–∞–Ω–∏–µ @username.
–ë–µ–∑ –∫–Ω–æ–ø–æ–∫ –∏ FSM.
"""
import os

import aiomax
from dotenv import load_dotenv

from rag_bot import answer_question
from config import MAX_VK_BOT_USERNAME as BOT_USERNAME


load_dotenv("keys.env")


TOKEN = os.getenv("MAX_VK_BOT_TOKEN")
if not TOKEN:
    raise RuntimeError("MAX_VK_BOT_TOKEN not found in keys.env")


bot = aiomax.Bot(TOKEN, default_format="markdown")


# ==================== –ü–†–ò–í–ï–¢–°–¢–í–ï–ù–ù–û–ï –°–û–û–ë–©–ï–ù–ò–ï ====================

WELCOME_MESSAGE = """üëã **–ü—Ä–∏–≤–µ—Ç! –Ø –±–æ—Ç-–ø–æ–º–æ—â–Ω–∏–∫ –ø–æ –ø–æ—Å—Ç—É–ø–ª–µ–Ω–∏—é –≤ –º–∞–≥–∏—Å—Ç—Ä–∞—Ç—É—Ä—É –ú–§–¢–ò.**

üéì –Ø –ø–æ–º–æ–≥—É —Ç–µ–±–µ —Ä–∞–∑–æ–±—Ä–∞—Ç—å—Å—è —Å:
‚Ä¢ –°—Ä–æ–∫–∞–º–∏ –∏ —ç—Ç–∞–ø–∞–º–∏ –ø–æ—Å—Ç—É–ø–ª–µ–Ω–∏—è
‚Ä¢ –ü–æ–¥–∞—á–µ–π –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ –∏ –∑–∞—è–≤–ª–µ–Ω–∏–π
‚Ä¢ –í—Å—Ç—É–ø–∏—Ç–µ–ª—å–Ω—ã–º–∏ –∏—Å–ø—ã—Ç–∞–Ω–∏—è–º–∏
‚Ä¢ –í—ã–±–æ—Ä–æ–º –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–π –∏ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–æ–≤

üìö –Ø –∑–Ω–∞—é –ø—Ä–∞–≤–∏–ª–∞ –ø—Ä–∏—ë–º–∞ –≤ **–º–∞–≥–∏—Å—Ç—Ä–∞—Ç—É—Ä—É** –ú–§–¢–ò 2025 –≥–æ–¥–∞.

üí¨ –ß—Ç–æ–±—ã –∑–∞–¥–∞—Ç—å –≤–æ–ø—Ä–æ—Å, —É–ø–æ–º—è–Ω–∏ –º–µ–Ω—è: @{bot_username} <—Ç–≤–æ–π –≤–æ–ø—Ä–æ—Å>

–ù–∞–ø—Ä–∏–º–µ—Ä: @{bot_username} –∫–∞–∫–∏–µ —Å—Ä–æ–∫–∏ –ø–æ–¥–∞—á–∏ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤?
""".format(bot_username=BOT_USERNAME)


# ==================== –û–ë–†–ê–ë–û–¢–ß–ò–ö–ò ====================

# –§–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —É—Ä–æ–≤–µ–Ω—å –¥–ª—è –≥—Ä—É–ø–ø–æ–≤—ã—Ö —á–∞—Ç–æ–≤
LEVEL = "master"


@bot.on_message()
async def handle_message(message: aiomax.Message):
    """–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏—è —Å —É–ø–æ–º–∏–Ω–∞–Ω–∏–µ–º –±–æ—Ç–∞."""

    text = (message.body.text or "").strip()

    # –ï—Å–ª–∏ –≤ —Å–æ–æ–±—â–µ–Ω–∏–∏ –Ω–µ—Ç —É–ø–æ–º–∏–Ω–∞–Ω–∏—è –±–æ—Ç–∞ ‚Äî –∏–≥–Ω–æ—Ä–∏—Ä—É–µ–º
    if f"@{BOT_USERNAME}" not in text:
        return

    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ —É–ø–æ–º–∏–Ω–∞–Ω–∏—è
    mention_count = text.count(f"@{BOT_USERNAME}")
    if mention_count > 1:
        await message.reply(
            "‚ö†Ô∏è –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —É–ø–æ–º–∏–Ω–∞–π—Ç–µ –º–µ–Ω—è —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω —Ä–∞–∑ –≤ —Å–æ–æ–±—â–µ–Ω–∏–∏."
        )
        return

    # –£–¥–∞–ª—è–µ–º —É–ø–æ–º–∏–Ω–∞–Ω–∏–µ –∏–∑ —Ç–µ–∫—Å—Ç–∞
    cleaned = text.replace(f"@{BOT_USERNAME}", "").strip()

    # –ï—Å–ª–∏ –ø—É—Å—Ç–æ–π –∑–∞–ø—Ä–æ—Å ‚Äî –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ
    if not cleaned:
        await message.reply(WELCOME_MESSAGE)
        return

    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–ª–∏–Ω—ã –∑–∞–ø—Ä–æ—Å–∞
    if len(cleaned) > 500:
        await message.reply(
            "–í–∞—à –≤–æ–ø—Ä–æ—Å —Å–ª–∏—à–∫–æ–º –¥–ª–∏–Ω–Ω—ã–π. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —Å—Ñ–æ—Ä–º—É–ª–∏—Ä—É–π—Ç–µ –µ–≥–æ –∫–æ—Ä–æ—á–µ (–¥–æ 500 —Å–∏–º–≤–æ–ª–æ–≤)."
        )
        return
    
    # –ü–æ–ª—É—á–∞–µ–º –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –æ—Ç–≤–µ—Ç –∏–∑ RAG-–±–æ—Ç–∞ (–≤—Å–µ–≥–¥–∞ –º–∞–≥–∏—Å—Ç—Ä–∞—Ç—É—Ä–∞)
    reply_text = answer_question(cleaned, level=LEVEL)
    await message.reply(reply_text)


@bot.on_bot_start()
async def on_bot_start(payload: aiomax.BotStartPayload):
    """–ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –ø—Ä–∏ –Ω–∞—á–∞–ª–µ —á–∞—Ç–∞ —Å –±–æ—Ç–æ–º."""
    await payload.send(WELCOME_MESSAGE)


@bot.on_bot_add()
async def on_bot_add(chat: aiomax.Chat):
    """–ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –±–æ—Ç–∞ –≤ —á–∞—Ç."""
    await bot.send_message(
        chat_id=chat.chat_id,
        text=WELCOME_MESSAGE
    )


def main() -> None:
    print("–ì—Ä—É–ø–ø–æ–≤–æ–π –±–æ—Ç –∑–∞–ø—É—â–µ–Ω (—Ç–æ–ª—å–∫–æ —É–ø–æ–º–∏–Ω–∞–Ω–∏—è), –æ–∂–∏–¥–∞—é —Å–æ–æ–±—â–µ–Ω–∏—è...")
    bot.run()


if __name__ == "__main__":
    main()
